<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Batch Text Layout Generator</title>

  <style>
    /* Import custom font */
    @font-face {
      font-family: 'URWGroteskWid-Lig';
      src: url('URWGroteskWid-Lig.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }

    h1 {
      text-align: center;
      margin: 20px 0;
      font-family: 'URWGroteskWid-Lig', sans-serif;
    }

    body {
      margin: 0;
      padding: 20px;
      overflow-x: auto;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    .content-area {
      width: 1800px;
      height: 920px;
      margin: 20px auto;
      position: relative;
      border: 1px solid #ccc;
      overflow: hidden;
      background-color: #fff;
      box-sizing: border-box;
      padding: 50px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .layout-container {
      width: 1700px;
      height: 820px;
      box-sizing: border-box;
      display: flex;
      gap: 100px;
      position: relative;
    }

    .left-container,
    .right-container {
      width: 800px;
      height: 820px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      border: 1px dashed #ccc;
      position: relative;
    }

    .left-container {
      justify-content: center;
      align-items: center;
    }

    .right-container {
      justify-content: center;
      align-items: center;
    }

    .image-container {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .image-placeholder {
      width: 800px;
      height: 460px;
      background-color: #f0f0f0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      color: #999;
      border: 2px solid #ddd;
    }

    .text-area {
      width: 800px;
      font-family: 'URWGroteskWid-Lig', sans-serif;
      font-size: 41px;
      font-weight: normal;
      line-height: 50px;
      letter-spacing: 0px;
      word-wrap: break-word;
    }

    .paragraph {
      font-family: 'URWGroteskWid-Lig', sans-serif;
      font-size: 41px;
      font-weight: normal;
      line-height: 50px;
      letter-spacing: 0px;
      word-wrap: break-word;
      width: 100%;
      margin-bottom: 30px;
    }

    .paragraph:last-child {
      margin-bottom: 0;
    }

    .control-panel {
      width: 1800px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-sizing: border-box;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .row {
      display: flex;
      gap: 20px;
    }

    .column {
      flex: 1;
    }

    textarea {
      width: 100%;
      height: 200px;
      padding: 12px;
      box-sizing: border-box;
      font-size: 14px;
      line-height: 1.5;
      font-family: monospace;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }

    button {
      padding: 10px 20px;
      font-size: 14px;
      margin-top: 10px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    #generateBtn, #processBatchBtn, #downloadBtn {
      background-color: #165DFF;
      color: white;
    }

    #generateBtn:hover, #processBatchBtn:hover, #downloadBtn:hover {
      background-color: #0E42CC;
    }

    #measureContainer {
      position: absolute;
      visibility: hidden;
      width: 800px;
      font-family: 'URWGroteskWid-Lig', sans-serif;
      font-size: 41px;
      line-height: 50px;
      word-wrap: break-word;
      top: -1000px;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .overflow-indicator {
      position: absolute;
      bottom: -25px;
      left: 0;
      width: 100%;
      text-align: center;
      color: #ff4d4f;
      font-size: 14px;
      font-family: sans-serif;
    }

    .content-wrapper {
      width: 100%;
      max-height: 100%;
      overflow: hidden;
      position: relative;
    }

    .text-container {
      width: 100%;
      position: relative;
    }

    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 15px;
      gap: 10px;
    }

    .pagination button {
      padding: 6px 12px;
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ccc;
      font-size: 12px;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .page-info {
      text-align: center;
      margin-top: 8px;
      font-size: 14px;
      color: #666;
    }

    .page {
      display: none;
      width: 100%;
      height: 100%;
    }

    .page.active {
      display: flex;
    }

    /* Batch processing styles */
    .batch-section {
      margin-top: 20px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 6px;
      border: 1px solid #eee;
    }

    .file-upload {
      margin-bottom: 15px;
    }

    .file-upload input {
      display: none;
    }

    .custom-file-upload {
      display: inline-block;
      padding: 8px 16px;
      background-color: #165DFF;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
      margin-right: 10px;
    }

    .custom-file-upload:hover {
      background-color: #0E42CC;
    }

    .file-status {
      color: #666;
      font-size: 14px;
    }

    .progress-container {
      margin: 15px 0;
    }

    .progress-bar {
      width: 100%;
      height: 16px;
      background-color: #f0f0f0;
      border-radius: 8px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background-color: #165DFF;
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      margin-top: 8px;
      font-size: 12px;
      color: #666;
    }

    .article-navigation {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
      justify-content: center;
    }

    .article-info {
      font-weight: bold;
      font-size: 14px;
    }

    .review-section {
      margin: 15px 0;
      padding: 12px;
      background-color: #e6f7ff;
      border-radius: 6px;
      border: 1px solid #91d5ff;
    }

    .review-options {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .review-options label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }

    .batch-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }

    .settings-section {
      margin: 10px 0;
      padding: 10px;
      background-color: #f0f9eb;
      border-radius: 6px;
      border: 1px solid #b7eb8f;
    }

    .settings-section label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .settings-section input {
      width: 60px;
      padding: 4px;
      border: 1px solid #ddd;
      border-radius: 3px;
    }

    .hidden {
      display: none;
    }

    .success-message {
      color: #52c41a;
      font-weight: bold;
      margin-top: 10px;
      font-size: 13px;
      text-align: center;
    }

    .error-message {
      color: #ff4d4f;
      font-size: 13px;
      margin-top: 5px;
    }

    .preview-info {
      margin-top: 10px;
      font-size: 13px;
      color: #666;
      font-style: italic;
    }

    .process-complete-text {
      color: #52c41a;
      font-weight: bold;
      margin-top: 10px;
      font-size: 14px;
      text-align: center;
    }


    /* Tab容器样式：控制按钮整体位置，与原页面宽度对齐 */
    .tab-container {
      width: 1800px; 
      margin: 0 auto; 
      padding-top: 20px; 
    }

    .tab-btn {
      padding: 10px 25px;
      font-size: 16px;
      border: none; 
      border-radius: 4px 4px 0 0; 
      cursor: pointer; 
      background-color: #f0f0f0; 
      transition: background-color 0.3s; 
      margin-right: 5px; 
    }


    .tab-btn.active {
      background-color: #165DFF; 
      color: white; 
      font-weight: 500;
    }

    .tab-btn:hover:not(.active) {
      background-color: #e0e0e0; 
    }

  </style>


 
</head>

<body>

  <!-- Tab按钮容器：包裹两个切换按钮 -->
  <div class="tab-container">
    <button class="tab-btn active" id="batchModifyBtn">batch modify</button>
    <button class="tab-btn" id="smallModifyBtn">small modify</button>
  </div>

  <h1>Batch Text Layout Generator</h1>

  <!-- Display area -->
  <div class="content-area">
    <div id="layoutDisplay" class="layout-container">
      Please upload Excel file and process batch to view results
    </div>
  </div>

  <!-- Pagination controls -->
  <div class="pagination" id="pagination" style="display: none;">
    <button id="prevPage">&lt; Previous</button>
    <button id="nextPage">Next &gt;</button>
  </div>
  <div class="page-info" id="pageInfo" style="display: none;">Page 1 of 1</div>

  <!-- Control panel -->
  <div class="control-panel">
    <div class="row">
      <div class="column">
        <label for="textInput">Current Passage Preview:</label>
        <textarea id="textInput" readonly placeholder="Passage content will appear here after processing"></textarea>
        
        <div class="preview-info">
          Layout preview updates automatically when navigating between articles
        </div>

        <!-- Settings section -->
        <div class="settings-section">
          <label>
            Maximum Pages to Extract:
            <input type="number" id="maxPages" value="10" min="1" max="20">
          </label>
        </div>
      </div>
      
      <div class="column">
        <!-- Batch processing section -->
        <div class="batch-section">
          <h3 style="margin-top: 0;">Batch Processing</h3>
          
          <div class="file-upload">
            <label for="excelFile">Upload Excel File (.xlsx):</label>
            <!-- 自定义文件上传控件 -->
            <label class="custom-file-upload" for="excelFile">Choose File</label>
            <input type="file" id="excelFile" accept=".xlsx" />
            <span class="file-status" id="fileStatus">No file chosen</span>
            <div style="font-size: 14px;font-weight: bold; color:  #ff4d4f; margin-top: 3px;">
              Required columns: id, passage
            </div>
          </div>
          
          <div class="progress-container hidden" id="progressContainer">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progressText">Processing 0/0</div>
          </div>
          
          <div class="article-navigation hidden" id="articleNavigation">
            <button id="prevArticle">&lt; Prev</button>
            <span class="article-info" id="articleInfo">Article 1 of 0</span>
            <button id="nextArticle">Next &gt;</button>
          </div>

          <!-- Review section -->
          <div class="review-section hidden" id="reviewSection">
            <label style="font-weight: bold; display: block; margin-bottom: 8px;">
              Review this layout:
            </label>
            <div class="review-options">
              <label>
                <input type="radio" name="review" value="yes"> Yes - Layout is good
              </label>
              <label>
                <input type="radio" name="review" value="no"> No - Needs adjustment
              </label>
            </div>
          </div>
          
          <div class="batch-controls">
            <button id="processBatchBtn" disabled>
              <span id="processButtonText">Process Batch</span>
              <span id="batchLoadingIndicator" class="loading" style="display:none;"></span>
            </button>
            <button id="downloadBtn" class="hidden">Download Results</button>
          </div>
          
          <div id="batchStatus" class="hidden"></div>
          
          <!-- 处理完成提示文本 -->
          <div id="processCompleteText" class="process-complete-text hidden">
            Batch processing completed successfully! Use navigation buttons to review each article.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden measurement container -->
  <div id="measureContainer"></div>

  <!-- Include SheetJS library -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Set fixed zoom to 33%
      document.body.style.zoom = "33%";

          
      // Tab 按钮
      // 1. 获取Tab按钮（需确保HTML中已添加Tab按钮元素）
      const batchModifyBtn = document.getElementById('batchModifyBtn');
      const smallModifyBtn = document.getElementById('smallModifyBtn');

      // 2. batch modify按钮点击：跳转到子页面+切换样式
      batchModifyBtn.addEventListener('click', function() {
        batchModifyBtn.classList.add('active');
        smallModifyBtn.classList.remove('active');
       
      });

      // 3. small modify按钮点击：跳转到子页面+切换样式
      smallModifyBtn.addEventListener('click', function() {
        smallModifyBtn.classList.add('active');
        batchModifyBtn.classList.remove('active');
        window.location.href = 'small_modify.html'; // 子页面文件名需和实际一致
        
      });
      

      // Get DOM elements
      const textInput = document.getElementById('textInput');
      const layoutDisplay = document.getElementById('layoutDisplay');
      const measureContainer = document.getElementById('measureContainer');
      const pagination = document.getElementById('pagination');
      const prevPageBtn = document.getElementById('prevPage');
      const nextPageBtn = document.getElementById('nextPage');
      const pageInfo = document.getElementById('pageInfo');
      const maxPagesInput = document.getElementById('maxPages');
      const fileStatus = document.getElementById('fileStatus');
      
      // Batch processing elements
      const excelFile = document.getElementById('excelFile');
      const processBatchBtn = document.getElementById('processBatchBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const articleNavigation = document.getElementById('articleNavigation');
      const prevArticleBtn = document.getElementById('prevArticle');
      const nextArticleBtn = document.getElementById('nextArticle');
      const articleInfo = document.getElementById('articleInfo');
      const batchStatus = document.getElementById('batchStatus');
      const processButtonText = document.getElementById('processButtonText');
      const batchLoadingIndicator = document.getElementById('batchLoadingIndicator');
      const reviewSection = document.getElementById('reviewSection');
      const reviewRadios = document.querySelectorAll('input[name="review"]');
      const processCompleteText = document.getElementById('processCompleteText');
      
      // Variables
      let fontLoaded = false;
      let currentPage = 0;
      let totalPages = 0;
      let pagesData = [];
      let batchData = [];
      let processedData = [];
      let currentArticleIndex = 0;
      
      // 自定义文件上传状态更新
      excelFile.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          // 显示文件名或固定文字"File Chosen"
          fileStatus.textContent = "File Chosen";
          // 如果想显示实际文件名，可使用下面这行
          // fileStatus.textContent = file.name;
        } else {
          fileStatus.textContent = "No file chosen";
        }
      });
      
      // Check if custom font is available
      function checkFontLoaded() {
        const testElement = document.createElement('span');
        testElement.style.position = 'absolute';
        testElement.style.visibility = 'hidden';
        testElement.style.fontFamily = 'sans-serif';
        testElement.style.fontSize = '20px';
        testElement.textContent = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        
        const referenceElement = testElement.cloneNode(true);
        referenceElement.style.fontFamily = 'URWGroteskWid-Lig, sans-serif';
        
        document.body.appendChild(testElement);
        document.body.appendChild(referenceElement);
        
        const isLoaded = testElement.offsetWidth !== referenceElement.offsetWidth;
        
        document.body.removeChild(testElement);
        document.body.removeChild(referenceElement);
        
        return isLoaded;
      }
      
      // Wait for font to load
      function waitForFontLoad() {
        return new Promise((resolve) => {
          if (checkFontLoaded()) {
            fontLoaded = true;
            resolve(true);
            return;
          }
          
          const interval = setInterval(() => {
            if (checkFontLoaded()) {
              clearInterval(interval);
              fontLoaded = true;
              resolve(true);
            }
          }, 100);
          
          setTimeout(() => {
            clearInterval(interval);
            resolve(false);
            fontLoaded = true;
          }, 3000);
        });
      }

      // Excel file upload handler
      excelFile.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        processButtonText.textContent = 'Processing...';
        batchLoadingIndicator.style.display = 'inline-block';
        processBatchBtn.disabled = true;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
            
            batchData = jsonData.map((row, index) => ({
              id: row.id || index + 1,
              passage: row.passage || '',
              originalData: row
            }));
            
            processButtonText.textContent = `Process ${batchData.length} Articles`;
            processBatchBtn.disabled = false;
            batchStatus.innerHTML = `<div class="success-message">Loaded ${batchData.length} articles successfully</div>`;
            batchStatus.classList.remove('hidden');
          } catch (error) {
            console.error('Error reading Excel file:', error);
            batchStatus.innerHTML = `<div class="error-message">Error reading Excel file: ${error.message}</div>`;
            batchStatus.classList.remove('hidden');
          } finally {
            batchLoadingIndicator.style.display = 'none';
          }
        };
        reader.readAsArrayBuffer(file);
      });

      // Process batch button handler
      processBatchBtn.addEventListener('click', async function() {
        if (batchData.length === 0) return;
        
        const maxPages = parseInt(maxPagesInput.value) || 10;
        
        processButtonText.textContent = 'Processing...';
        batchLoadingIndicator.style.display = 'inline-block';
        processBatchBtn.disabled = true;
        progressContainer.classList.remove('hidden');
        
        processedData = [];
        
        for (let i = 0; i < batchData.length; i++) {
          // Update progress
          const progress = ((i + 1) / batchData.length) * 100;
          progressFill.style.width = `${progress}%`;
          progressText.textContent = `Processing ${i + 1}/${batchData.length}`;
          
          // Process current article
          const article = batchData[i];
          const paragraphs = article.passage.split(/\n+/)
            .filter(para => para.trim() !== '')
            .map(para => para.replace(/^- /, '').trim());
          
          const pages = calculatePages(paragraphs, true, false);
          
          // Extract page contents (up to maxPages)
          const pageContents = [];
          for (let p = 0; p < Math.min(pages.length, maxPages); p++) {
            const page = pages[p];
            let content = '';
            if (page.left_paras.length > 0) {
              content += page.left_paras.join('\n') + '\n';
            }
            if (page.right_paras.length > 0) {
              content += page.right_paras.join('\n');
            }
          }
        }
      });
    });
  </script>
  <!-- 在这里添加缓存清除脚本 -->
  <script>
    // 强制浏览器不使用缓存版本
    if (window.performance) {
    if (performance.navigation.type === 1) {
    // 如果是刷新操作，重新加载并清除缓存
    window.location.reload(true);
        }
    }

  // 或者更简单的方法：每次加载都添加随机参数
   document.addEventListener('DOMContentLoaded', function() {
     const links = document.querySelectorAll('link[rel="stylesheet"]');
     const scripts = document.querySelectorAll('script[src]');
      
     const timestamp = '?v=' + new Date().getTime();
      
     links.forEach(link => {
       const href = link.href;
       if (href && href.indexOf('?') === -1) {
         link.href = href + timestamp;
       }
      });
      
     scripts.forEach(script => {
        const src = script.src;
        if (src && src.indexOf('?') === -1 && !script.hasAttribute('data-no-cache')) {
          script.src = src + timestamp;
        }
      });
    });
    </script>

</body>
</html>
